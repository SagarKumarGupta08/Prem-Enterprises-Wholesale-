<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Wholesale Admin</title>
  <style>
    :root{--bg:#f7f9fb;--card:#fff;--accent:#1e88e5;--muted:#6b7280;--active-link:#0b3740}
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:var(--bg);color:#111;overflow-x:hidden}
    /* Top header */
    header{position:fixed;left:0;right:0;top:0;height:56px;background:#0b3740;color:#fff;display:flex;align-items:center;gap:12px;padding:8px 12px;z-index:60}
    .hamb{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;border:none;color:#fff;font-size:22px}
    .brand{font-weight:700;font-size:16px}
    .container{max-width:1000px;margin:84px auto 40px;padding:12px} /* leave space for fixed header */

    /* Cards & layout */
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.03);margin-bottom:14px}
    h2{margin:0 0 12px 0}
    label{display:block;margin-top:8px;font-weight:600}
    input,select,button,textarea{padding:9px;border-radius:8px;border:1px solid #ddd;font-size:15px}
    input,select,textarea{width:100%}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    .btn{background:var(--accent);color:#fff;padding:9px 14px;border-radius:8px;border:none;cursor:pointer}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .small{font-size:13px;color:var(--muted)}
    .products-scroll { max-height:260px; overflow-y:auto; overflow-x:hidden; border-radius:8px; background:#fff; padding:0; border:1px solid #eee;}
    .products-scroll table { margin:0; width:100% }
    .link-like{color:var(--accent); text-decoration:none; cursor:pointer}
    .btn-ghost{background:#eee;color:#111;border-radius:8px;padding:8px 10px;border:none;cursor:pointer}
    .picker-btn{width:100%;text-align:left;padding:9px;border-radius:8px;background:#fff;border:1px solid #ddd;cursor:pointer}
    .picker-display{padding:9px;border-radius:8px;background:#fff;border:1px solid #ddd}
    .muted{color:var(--muted)}
    @media (max-width:600px){ .row{flex-direction:column} }

    /* Drawer */
    .drawer{position:fixed;left:-280px;top:0;width:280px;height:100%;background:#fff;box-shadow:2px 0 12px rgba(0,0,0,0.12);z-index:70;transition:left .22s ease;padding:18px}
    .drawer.open{left:0}
    .drawer h3{margin:0 0 12px 0}
    .drawer button{display:block;padding:10px;border-radius:8px;color:#0b3740;text-decoration:none;margin-bottom:6px;border:none;background:transparent;text-align:left;cursor:pointer}
    .drawer button:hover{background:#f0f7fb}
    .drawer button.active{background:#e0f2ff; font-weight:700; color:var(--accent)} /* Active state for menu link */
    .overlay-dim{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);z-index:65}
    .overlay-dim.show{display:block}

    /* modal/picker overlay */
    .overlay{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:200;align-items:center;justify-content:center}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:10px;padding:12px;max-width:920px;width:94%;max-height:80%;overflow:auto}
    .search-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}
    .list-item{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
    .list-item:hover{background:#f3f7fb}

    /* welcome */
    .welcome-banner{background:linear-gradient(90deg,#e6f7ff,#fff);border-radius:12px;padding:26px;text-align:center;margin-bottom:18px;box-shadow:0 3px 8px rgba(0,0,0,0.03);font-weight:700;font-size:26px}
    
    /* Class to hide sections */
    .hidden-section { display: none; }

    /* NEW STYLES: Styling for suggestion list items */
    #product_suggestion_list .list-item { 
      padding: 8px 12px; 
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #product_suggestion_list .list-item:last-child {
      border-bottom: none;
    }
    .suggestion-list-container {
      max-height: 180px; 
      overflow-y: auto;
      /* Border is added/removed via JS, or just use CSS to ensure it's boxed when visible */
      border: 1px solid #ddd; 
      border-top: none;
    }
  </style>
</head>
<body>

<header>
  <button class="hamb" id="hambBtn" aria-label="menu">☰</button>
  <div class="brand">Wholesale Admin</div>
</header>

<div id="drawer" class="drawer" aria-hidden="true">
  <h3>Menu</h3>
  <button data-target="products-section" onclick="navTo(event)" class="menu-link">Product listing</button>
  <button data-target="retailers-section" onclick="navTo(event)" class="menu-link">Add retailer</button>
  <button data-target="create-order-section" onclick="navTo(event)" class="menu-link">Create order</button>
  <button data-target="recent-orders-section" onclick="navTo(event)" class="menu-link">Recent orders</button>

  <hr style="margin:12px 0;border:none;border-top:1px solid #eee">
  <div style="font-size:13px;color:#666">Quick actions</div>
  <button onclick="exportCSV()">Export CSV</button>
</div>
<div id="drawerOverlay" class="overlay-dim" onclick="closeDrawer()"></div>

<main class="container">

  <div class="welcome-banner">Welcome to abcd enterprises</div>

  <div id="products-section" class="card">
    <h2>Add Product / Update Stock</h2>
    <div class="row">
      <div class="col">
        <label>Product name</label>
        
        <div id="product_name_wrapper" style="position: relative;"> 
            <input id="p_name" oninput="searchProductForUpdate()"> 
            
            <div id="product_suggestion_list" class="suggestion-list-container" 
                style="display:none; position: absolute; width: 100%; z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background:#fff; margin-top: 1px; left:0; top: 100%;">
                </div>
        </div>
        
        <label>CP (cost price)</label><input id="p_cp" type="number" step="0.01">
        <label>SP (sell price)</label><input id="p_sp" type="number" step="0.01">
        <label>MRP</label><input id="p_mrp" type="number" step="0.01">
        
        <label>New Stock to Add (Current: <span id="current_stock_display">0</span>)</label>
        <input id="p_stock" type="number" value="0">
        
        <div style="margin-top:12px">
            <button class="btn" id="save_product_btn" onclick="addProduct()">Save Product</button>
            <input type="hidden" id="current_product_id">
        </div>
      </div>

      <div class="col">
        <h3>Products</h3>
        <div class="products-scroll">
          <table id="products_table">
            <thead><tr><th>Name</th><th>CP</th><th>SP</th><th>Stock</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="retailers-section" class="card hidden-section">
    <h2>Add Retailer</h2>
    <div class="row">
      <div class="col">
        <label>Shop name</label><input id="r_name">
        <label>Address</label><input id="r_address">
        <label>Phone</label><input id="r_phone">
        <div style="margin-top:12px"><button class="btn" onclick="addRetailer()">Save Retailer</button></div>
      </div>

      <div class="col">
        <h3>Retailers</h3>
        <label class="small">Search retailers</label>
        <input id="retailer_search" class="search-input" placeholder="Type shop name or phone to filter..." oninput="filterRetailers()">
        <table id="retailers_table" class="table"><thead><tr><th>Shop</th><th>Phone</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div id="create-order-section" class="card hidden-section">
    <h2>Create Order</h2>
    <div style="margin-bottom:8px">
      <label>Select Retailer</label>
      <select id="order_retailer"><option value="">-- Select --</option></select>
    </div>

    <div id="order_items"></div>

    <div style="margin-top:15px; border-top:1px dashed #ddd; padding-top:10px;">
        <strong style="font-size:1.1em">Grand Total: ₹<span id="order_grand_total">0.00</span></strong>
    </div>
    <div style="margin-top:10px">
      <button class="btn-ghost" onclick="addRow()">Add more item</button>
      <button class="btn" onclick="placeOrder()" style="margin-left:10px">Place Order</button>
    </div>
  </div>

  <div id="recent-orders-section" class="card hidden-section">
    <h2>Recent Orders</h2>
    <table id="orders_table" class="table"><thead><tr><th>Date</th><th>Retailer</th><th>Items</th><th>Total</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

</main>

<div id="productPickerOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong style="font-size:18px">-- Product --</strong>
      <button onclick="closeProductPicker()" style="background:#eee;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
    </div>
    <input id="product_search" class="search-input" placeholder="Search product name, SP, stock..." oninput="renderProductPickerList()">
    <div id="product_list" style="border-radius:8px;overflow:auto;max-height:420px"></div>
  </div>
</div>

<div id="modalOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 id="modalTitle">Details</h3>
      <button onclick="closeModal()" style="background:#eee;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
    </div>
    <div id="modalContent" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ---------- Globals ---------- */
let PRODUCTS_CACHE = [];
let RETAILERS_CACHE = [];
let CURRENT_PICKER_ROW = null;
const ALL_SECTIONS = ['products-section', 'retailers-section', 'create-order-section', 'recent-orders-section'];

/* ------ Drawer open/close (ensure single panel open) ------ */
const hambBtn = document.getElementById('hambBtn');
const drawer = document.getElementById('drawer');
const drawerOverlay = document.getElementById('drawerOverlay');

hambBtn.addEventListener('click', ()=> openDrawer());

function openDrawer(){
  // close other overlays (only one panel at a time)
  closeProductPicker();
  closeModal();

  drawer.classList.add('open');
  drawerOverlay.classList.add('show');
  drawer.setAttribute('aria-hidden','false');
}
function closeDrawer(){
  drawer.classList.remove('open');
  drawerOverlay.classList.remove('show');
  drawer.setAttribute('aria-hidden','true');
}

/* close drawer when overlay clicked */
drawerOverlay.addEventListener('click', closeDrawer);

/* navTo (buttons inside drawer) - UPDATED to hide/show sections and highlight active link */
function navTo(e){
  e.preventDefault();
  // if clicked via keyboard or button, get dataset
  const target = e.currentTarget?.dataset?.target || e.target?.dataset?.target;
  // ensure drawer closed and other panels closed
  closeDrawer();
  closeProductPicker();
  closeModal();
  
  if(!target) return;

  // Hide all sections first
  ALL_SECTIONS.forEach(id => {
    const el = document.getElementById(id);
    if(el && id !== target){
        el.classList.add('hidden-section');
    }
  });

  // Show the target section
  const el = document.getElementById(target);
  if(el){
    el.classList.remove('hidden-section'); // Make the target visible
    // Scroll to the section (adjusted)
    el.scrollIntoView({behavior:'smooth', block:'start'});
    window.scrollBy(0, -70);
  }
  
  // Highlight active link
  document.querySelectorAll('.menu-link').forEach(link => {
      if (link.dataset.target === target) {
          link.classList.add('active');
      } else {
          link.classList.remove('active');
      }
  });
}

/* ----- Product / Retailer CRUD (calls flask endpoints) ----- */
async function getJSON(url){ const r = await fetch(url); return r.json(); }

// UPDATED: Handles both Add New Product and Update Stock/Details
async function addProduct(){
  const currentId = document.getElementById('current_product_id').value;
  
  // 1. Check if we are updating an existing product (Restock/Update)
  if (currentId) {
    const data = {
      id: parseInt(currentId),
      // We are only sending the NEW stock to add, backend will handle the addition
      stock_to_add: parseInt(document.getElementById('p_stock').value || 0),
      // If we are updating, we allow changing CP/SP/MRP
      cp: document.getElementById('p_cp').value,
      sp: document.getElementById('p_sp').value,
      mrp: document.getElementById('p_mrp').value,
    };
    
    // NOTE: This assumes your Flask backend has an endpoint like /api/update_product_stock
    const res = await fetch('/api/update_product_stock', {
        method:'POST', headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify(data)
    });
    const j = await res.json();
    
    if(j.ok){
      alert(`Stock and details updated for product ID ${currentId}`); 
      resetProductForm(); // Reset the form after success
      refreshAll(); 
    } else { alert('Update Error: '+(j.error||'')); }
    return;
  }
  
  // 2. If no currentId, proceed to add a NEW product
  const data = {
    name: document.getElementById('p_name').value,
    cp: document.getElementById('p_cp').value,
    sp: document.getElementById('p_sp').value,
    mrp: document.getElementById('p_mrp').value,
    stock: document.getElementById('p_stock').value // This is initial stock
  };
  const res = await fetch('/api/add_product', {
      method:'POST', headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(data)
  });
  const j = await res.json();
  if(j.ok){ 
    alert('New Product saved'); 
    resetProductForm();
    refreshAll(); 
  } else { alert('Error: '+(j.error||'')); }
}

async function addRetailer(){
  const data = { shop_name: document.getElementById('r_name').value, address: document.getElementById('r_address').value, phone: document.getElementById('r_phone').value };
  const res = await fetch('/api/add_retailer', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  const j = await res.json();
  if(j.ok){ alert('Retailer saved'); document.getElementById('r_name').value=''; refreshAll(); } else { alert('Error: '+(j.error||'')); }
}

// NEW: Function to reset the Add Product form fields
function resetProductForm(){
    document.getElementById('p_name').value = '';
    document.getElementById('p_cp').value = '';
    document.getElementById('p_sp').value = '';
    document.getElementById('p_mrp').value = '';
    document.getElementById('p_stock').value = '0';
    document.getElementById('current_product_id').value = '';
    document.getElementById('save_product_btn').textContent = 'Save Product';
    document.getElementById('current_stock_display').textContent = '0';
    document.getElementById('product_suggestion_list').innerHTML = '';
    document.getElementById('product_suggestion_list').style.display = 'none';
}

/* UPDATED: Product Auto-Search/Auto-Fill for Updating Stock */
function searchProductForUpdate() {
    const input = document.getElementById('p_name');
    const q = input.value.trim().toLowerCase();
    const list = document.getElementById('product_suggestion_list');
    list.innerHTML = '';

    // Hide the list by default
    list.style.display = 'none'; 
    
    // If search box is empty, reset the form logic
    if (q === '') {
        resetProductForm();
        return;
    }
    
    // Filter products from cache
    const filtered = PRODUCTS_CACHE.filter(p => (p.name || '').toLowerCase().includes(q));

    if (filtered.length > 0) {
        list.style.display = 'block'; // Show the list if results are found
        
        filtered.slice(0, 5).forEach(p => { // Show max 5 suggestions
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = `${escapeHtml(p.name)} (Stock: ${p.stock})`;
            // Stop propagation to prevent form reset when clicking on the list item
            div.onclick = (e) => { 
                e.stopPropagation(); 
                selectProductForUpdate(p); 
                list.style.display = 'none'; // Hide list after selection
            }; 
            list.appendChild(div);
        });
    }
}

function selectProductForUpdate(product) {
    // 1. Auto-fill the form fields with existing data
    document.getElementById('p_name').value = product.name;
    document.getElementById('p_cp').value = product.cp;
    document.getElementById('p_sp').value = product.sp;
    document.getElementById('p_mrp').value = product.mrp;
    
    // 2. Set hidden ID, change button text and stock display
    document.getElementById('current_product_id').value = product.id;
    document.getElementById('save_product_btn').textContent = 'Update Stock & Details';
    document.getElementById('current_stock_display').textContent = product.stock;
    document.getElementById('p_stock').value = '0'; // Keep stock input at 0 for new quantity to be added
    
    // 3. Clear suggestions
    document.getElementById('product_suggestion_list').innerHTML = '';
    document.getElementById('product_suggestion_list').style.display = 'none';
}

/* ----- Order rows and picker - UPDATED addRow for total calculation----- */
function addRow(productId=null, qty=1){
  const container = document.getElementById('order_items');
  const idx = Date.now() + Math.floor(Math.random()*1000);
  const div = document.createElement('div'); div.className='row order-row'; div.style.marginBottom='10px';
  div.dataset.rowId = idx;
  div.innerHTML = `
    <div style="flex:2">
      <label>Product</label>
      <div style="display:flex;gap:8px">
        <div style="flex:3">
          <div class="picker-display" id="display_${idx}">-- Select product --</div>
          <input type="hidden" class="order_product_id" id="input_${idx}" value="${productId||''}">
        </div>
        <div style="flex:1">
          <button class="picker-btn" onclick="openProductPicker('${idx}')">Choose product</button>
        </div>
      </div>
    </div>
    <div style="flex:1">
      <label>Qty</label><input type="number" class="order_qty" value="${qty}" oninput="updateOrderTotal()">
    </div>
    <div style="flex:1;display:flex;align-items:flex-end">
      <button class="btn-ghost" onclick="removeRow(this); updateOrderTotal()">Remove</button>
    </div>
  `;
  container.appendChild(div);
  if(productId) {
    const p = PRODUCTS_CACHE.find(x=>x.id==productId);
    if(p) document.getElementById(`display_${idx}`).textContent = `${p.name} (SP:${p.sp}, Stock:${p.stock})`;
  }
  updateOrderTotal(); // Call update total when a new row is added
}
function removeRow(btn){ btn.closest('.row').remove(); }

/* Open product picker (close drawer & modals to ensure only one panel) */
function openProductPicker(rowId){
  // ensure single panel
  closeDrawer();
  closeModal();
  CURRENT_PICKER_ROW = rowId;
  document.getElementById('product_search').value = '';
  renderProductPickerList();
  document.getElementById('productPickerOverlay').classList.add('show');
}
function closeProductPicker(){
  document.getElementById('productPickerOverlay').classList.remove('show');
  CURRENT_PICKER_ROW = null;
}

/* Render picker list (same) */
function renderProductPickerList(){
  const q = (document.getElementById('product_search').value||'').trim().toLowerCase();
  const list = document.getElementById('product_list');
  list.innerHTML = '';
  const filtered = PRODUCTS_CACHE.filter(p=>{
    if(!q) return true;
    return (p.name||'').toString().toLowerCase().includes(q) ||
           (p.sp||'').toString().toLowerCase().includes(q) ||
           (p.stock||'').toString().toLowerCase().includes(q);
  });
  if(filtered.length===0){ list.innerHTML = '<div style="padding:12px;color:#666">No products</div>'; return; }
  filtered.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `<div>
        <div style="font-weight:600">${escapeHtml(p.name)}</div>
        <div class="muted" style="font-size:13px">SP: ₹${p.sp} · Stock: ${p.stock} · CP: ₹${p.cp}</div>
      </div>
      <div><button onclick="selectProduct(${p.id})" style="background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer">Select</button></div>`;
    list.appendChild(div);
  });
}

/* UPDATED selectProduct function to call updateOrderTotal */
function selectProduct(pid){
  const id = CURRENT_PICKER_ROW;
  if(!id) return;
  const input = document.getElementById(`input_${id}`);
  const display = document.getElementById(`display_${id}`);
  if(!input || !display) return;
  const p = PRODUCTS_CACHE.find(x=>x.id==pid);
  input.value = pid;
  display.textContent = `${p.name} (SP:${p.sp}, Stock:${p.stock})`;
  closeProductPicker();
  updateOrderTotal(); // Call update total when a product is selected
}

/* NEW: Function to dynamically calculate the order total */
function updateOrderTotal(){
  const rows = document.querySelectorAll('#order_items .order-row');
  let grandTotal = 0;

  for(const r of rows){
    const pid = r.querySelector('.order_product_id').value;
    const qty = parseInt(r.querySelector('.order_qty').value || 0);
    
    if(pid && qty > 0){
        const product = PRODUCTS_CACHE.find(p => p.id == pid);
        if(product){
            const sp = parseFloat(product.sp || 0); // Get Selling Price
            grandTotal += (sp * qty);
        }
    }
  }

  document.getElementById('order_grand_total').textContent = grandTotal.toFixed(2);
}


/* ----- Place order (WITH RETAILER CHECK) ----- */
async function placeOrder(){
  const retailer_id_value = document.getElementById('order_retailer').value;

  // FIX: Check if retailer is selected (Client-side validation)
  if (!retailer_id_value) {
    alert('Please select a retailer before placing the order.');
    return;
  }
  
  const rows = document.querySelectorAll('#order_items .order-row');
  const items = [];
  
  for(const r of rows){
    const pid = r.querySelector('.order_product_id').value;
    const q = parseInt(r.querySelector('.order_qty').value||0);
    if(pid && q>0) items.push({product_id: parseInt(pid), qty: q});
  }
  if(items.length===0){ alert('Add at least one item'); return; }
  
  const retailer_id = retailer_id_value; // Send non-empty string to backend
  
  const res = await fetch('/api/place_order', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({retailer_id, items})});
  const j = await res.json();
  if(j.ok){ alert('Order placed (id '+j.order_id+')'); document.getElementById('order_items').innerHTML=''; addRow(); refreshAll();
  } else { alert('Error: '+(j.error||'Unknown')); }
}

/* ----- Orders actions (same) ----- */
async function deleteOrder(id){
  if(!confirm("Delete order? Stock will be restored.")) return;
  const res = await fetch("/api/delete_order/" + id, {method: "POST"});
  const j = await res.json();
  if(j.ok){ alert("Order deleted & stock restored"); refreshAll(); } else { alert("Error: " + j.error); }
}
async function deliverOrder(id){
  if(!confirm("Mark order as delivered?")) return;
  const res = await fetch("/api/deliver_order/" + id, {method: "POST"});
  const j = await res.json();
  if(j.ok){ alert("Order marked delivered"); refreshAll(); } else { alert("Error: " + j.error); }
}

/* ----- Retailer details modal (same) ----- */
async function showRetailerPopup(rid){
  // ensure only this modal is open
  closeDrawer();
  closeProductPicker();
  const rres = await getJSON('/api/retailer/' + rid);
  if(!rres.ok){ alert('Retailer not found'); return; }
  const retailer = rres.retailer;
  const ores = await getJSON('/api/retailer_orders/' + rid);
  const orders = ores.ok ? ores.orders : [];

  let html = `<div style="display:flex;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:220px">
      <h4>Shop</h4>
      <p><strong>${escapeHtml(retailer.shop_name)}</strong></p>
      <p>${escapeHtml(retailer.address || '')}</p>
      <p>Phone: ${escapeHtml(retailer.phone || '')}</p>
    </div>
    <div style="flex:2;min-width:260px">
      <h4>Orders (${orders.length})</h4>`;

  if(orders.length===0){
    html += '<p class="small">No orders yet</p>';
  } else {
    orders.forEach(o=>{
      html += `<div style="border-top:1px solid #eee;padding-top:10px;margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong>Order #${o.id}</strong> <small style="color:#666;margin-left:8px">${(new Date(o.date)).toLocaleString()}</small></div>
          <div style="font-weight:700">Total: ₹${o.grand_total}</div>
        </div>
        <div style="margin-top:8px">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="border-bottom:1px solid #ddd">
                <th style="text-align:left;padding:6px">Product</th>
                <th style="text-align:right;padding:6px">Qty</th>
                <th style="text-align:right;padding:6px">SP</th>
                <th style="text-align:right;padding:6px">Item</th>
              </tr>
            </thead>
            <tbody>`;
      o.items.forEach(it=>{
        html += `<tr>
          <td style="padding:6px">${escapeHtml(it.product_name)}</td>
          <td style="padding:6px;text-align:right">x${it.qty}</td>
          <td style="padding:6px;text-align:right">₹${it.sp}</td>
          <td style="padding:6px;text-align:right">₹${it.item_total}</td>
        </tr>`;
      });
      html += `</tbody></table>
        </div>
      </div>`;
    });
  }

  html += `</div></div>`;

  document.getElementById('modalTitle').textContent = 'Retailer Details';
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal(){ document.getElementById('modalOverlay').classList.remove('show'); }

/* ----- Render / Refresh all data (same) ----- */
async function refreshAll(){
  // fetch products
  const prods = await getJSON('/api/products');
  PRODUCTS_CACHE = prods.map(p=>({id:p.id,name:p.name,cp:p.cp,sp:p.sp,mrp:p.mrp,stock:p.stock}));
  const tbody = document.querySelector('#products_table tbody'); tbody.innerHTML='';
  PRODUCTS_CACHE.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>₹${p.cp}</td><td>₹${p.sp}</td><td>${p.stock}</td>`;
    tbody.appendChild(tr);
  });

  // fetch retailers
  const retailers = await getJSON('/api/retailers');
  RETAILERS_CACHE = retailers;
  renderRetailersTable();

  // orders
  const orders = await getJSON('/api/orders');
  const oBody = document.querySelector('#orders_table tbody'); oBody.innerHTML='';
  orders.forEach(o=>{
    const row = document.createElement('tr');
    // Timezone fix: Date object will now correctly interpret the 'Z' suffix from the backend
    row.innerHTML = `<td>${(new Date(o.date)).toLocaleString()}</td>
                     <td><a class="link-like order-retailer" data-rid="${o.retailer_id||''}">${o.retailer||''}</a></td>
                     <td>${o.total_items}</td><td>₹${o.grand_total}</td>
                     <td>${o.status}</td>
                     <td class="order-actions">
                       ${o.status === "pending" ? `<button class="btn-ghost" onclick="deliverOrder(${o.id})">Delivered</button>
                       <button class="btn-ghost" onclick="deleteOrder(${o.id})">Delete</button>` : `<span class="small">${o.status}</span>`}
                     </td>`;
    oBody.appendChild(row);
  });

  document.querySelectorAll('.order-retailer').forEach(el=>{
    el.addEventListener('click', (e)=>{
      const rid = e.target.getAttribute('data-rid');
      if(rid) showRetailerPopup(rid);
    });
  });
}

function renderRetailersTable(){
  const q = (document.getElementById('retailer_search').value||'').trim().toLowerCase();
  const tb = document.querySelector('#retailers_table tbody'); tb.innerHTML='';
  const sel = document.getElementById('order_retailer'); sel.innerHTML = '<option value="">-- Select --</option>';
  RETAILERS_CACHE.forEach(r=>{
    const text = (r.shop_name||'') + ' ' + (r.phone||'');
    if(q && !text.toLowerCase().includes(q)) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a class="link-like retailer-link" data-rid="${r.id}">${escapeHtml(r.shop_name)}</a></td><td>${escapeHtml(r.phone||'')}</td>`;
    tb.appendChild(tr);
    const o = document.createElement('option'); o.value = r.id; o.textContent = r.shop_name + (r.phone? ' - '+r.phone : '');
    sel.appendChild(o);
  });
  document.querySelectorAll('.retailer-link').forEach(el=>{
    el.addEventListener('click', (e)=>{
      const rid = e.target.getAttribute('data-rid');
      showRetailerPopup(rid);
    });
  });
}
function filterRetailers(){ renderRetailersTable(); }

/* ----- Utilities (same) ----- */
function escapeHtml(text){ if(text===null||text===undefined) return ''; return text.toString().replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
function exportCSV(){ window.open('/export','_blank'); }

/* ----- Init: Set default view and load data ----- */
window.addEventListener('load', ()=>{
  // Initial setup: Hide all sections except the default one
  const defaultSectionId = 'products-section';
  ALL_SECTIONS.forEach(id => {
    const el = document.getElementById(id);
    if(el && id !== defaultSectionId){
        el.classList.add('hidden-section');
    } else if (el) {
        el.classList.remove('hidden-section'); // Ensure default is visible
    }
  });

  // Highlight the default menu link
  document.querySelector(`.menu-link[data-target="${defaultSectionId}"]`).classList.add('active');

  addRow(); // add one order row by default
  refreshAll();
});

/* close product picker/modal when Escape pressed */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){ closeProductPicker(); closeModal(); closeDrawer(); }
});
</script>
</body>
</html>
